name: aml-mlops-cicd

on:
  workflow_dispatch:

permissions:
  id-token: write         # REQUIRED for OIDC
  contents: read

env:
  # ==== Azure ML workspace context (from your config) ====
  AZURE_SUBSCRIPTION_ID: f7583458-6f5b-4491-add9-f827568d2957
  AZURE_RESOURCE_GROUP:  MSFT-AI-Class
  AZURE_ML_WORKSPACE:    MyFirstWorkSpace
  AZURE_REGION:          eastus

  # ==== Azure ML runtime bits ====
  AML_COMPUTE:           Keith-Compute
  AML_JOB_NAME:          auto-pricing-e2e
  AML_INPUT_DATA:        azureml:UsedCars:1

jobs:
  build-train-register:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ---------- Option A (OIDC) login ----------
      # Create an Entra app (or use existing), grant it ML Workspace Reader or higher,
      # and add a federated credential for this repo. Then store these as *Repository Variables*:
      #   AZURE_TENANT_ID, AZURE_CLIENT_ID
      - name: Azure CLI login (OIDC)
        uses: azure/login@v2
        with:
          tenant-id:       ${{ vars.AZURE_TENANT_ID }}
          client-id:       ${{ vars.AZURE_CLIENT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Verify login
        run: az account show -o table

      - name: Install Azure ML CLI v2
        run: |
          az extension add -n ml -y || az extension update -n ml

      - name: Submit Azure ML pipeline job
        id: submit
        shell: bash
        run: |
          set -euo pipefail
          JOB="${AML_JOB_NAME}-$(date +%y%m%d-%H%M%S)"
          echo "JOB=$JOB" >> $GITHUB_OUTPUT

          # submit the pipeline (inline components are in aml/pipeline.yml)
          az ml job create \
            --file aml/pipeline.yml \
            --name "$JOB" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --workspace-name  "$AZURE_ML_WORKSPACE" \
            --set experiment_name="$AML_JOB_NAME" \
                  inputs.data="$AML_INPUT_DATA" \
                  inputs.target_column="price" \
                  inputs.n_estimators=200 \
                  inputs.max_depth=10

      - name: Post Azure ML Studio link
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          JOB="${{ steps.submit.outputs.JOB }}"
          LINK="https://ml.azure.com/experiments/${AML_JOB_NAME}/jobs/${JOB}/overview?wsid=/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourceGroups/${AZURE_RESOURCE_GROUP}/providers/Microsoft.MachineLearningServices/workspaces/${AZURE_ML_WORKSPACE}"
          echo "Studio Link: ${LINK}"
          echo "Studio Link: ${LINK}" >> $GITHUB_STEP_SUMMARY

      - name: Upload job.json artifact
        if: always()
        run: |
          echo "{\"job\":\"${{ steps.submit.outputs.JOB }}\"}" > aml-job.json
          echo "sha256=$(sha256sum aml-job.json | cut -d' ' -f1)"
        continue-on-error: true
