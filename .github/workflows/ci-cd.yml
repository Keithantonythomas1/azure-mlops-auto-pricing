name: aml-mlops-cicd
on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  # Azure resources (from your portal screenshots)
  AZURE_RESOURCE_GROUP: MSFT-AI-Class
  AZURE_ML_WORKSPACE:  MyFirstWorkSpace
  AZURE_REGION:        eastus

  # Pipeline config
  AML_PIPELINE_FILE:   pipelines/pipeline.yml
  AML_JOB_NAME:        auto-pricing-e2e
  AML_INPUT_DATA:      '@azureml:UsedCars:1'
  AML_COMPUTE:         Keith-Compute

jobs:
  build-train-register:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'


      # ---------- TOOLS ----------
      - name: Install/upgrade Azure CLI + ML v2 extension
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ”¹ Upgrading Azure CLI to a modern version..."
          sudo apt-get update
          # Install Microsoft repo script (safe for GH runners) to get latest az
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

          echo "ðŸ”¹ Removing legacy ML extension if present..."
          az extension remove -n azure-cli-ml || true   # v1 extension

          echo "ðŸ”¹ Installing ML v2 extension..."
          az extension add -n ml --upgrade -y           # v2 extension

          echo "ðŸ”¹ Verifying versions..."
          az version
          az extension show -n ml

          echo "ðŸ”¹ Python SDK deps..."
          python -m pip install --upgrade pip
          pip install 'azure-ai-ml>=1.16.0' 'azure-identity>=1.16.0'

          echo "âœ… Azure CLI and ML v2 extension ready."


      # ---------- SUBMIT PIPELINE ----------
      - name: Submit Azure ML pipeline job
        id: submit
        shell: bash
        run: |
          set -euo pipefail
          JOB_JSON=$(az ml job create \
            --file "${AML_PIPELINE_FILE}" \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --workspace-name "${AZURE_ML_WORKSPACE}" \
            --name "${AML_JOB_NAME}" \
            --set inputs.data=${AML_INPUT_DATA} \
            --set inputs.compute_target="${AML_COMPUTE}" \
            --only-show-errors)
          echo "$JOB_JSON" > job.json
          echo "job_name=$(python - <<'PY'\nimport json;print(json.load(open('job.json'))['name'])\nPY\n)" >> "$GITHUB_OUTPUT"

      # ---------- SUMMARY & ARTIFACTS ----------
      - name: Post Studio link
        run: |
          URL=$(az ml job show -n "${{ steps.submit.outputs.job_name }}" \
                --resource-group "${AZURE_RESOURCE_GROUP}" \
                --workspace-name "${AZURE_ML_WORKSPACE}" \
                --query "studio_url || studioUrl" -o tsv)
          {
            echo "## Azure ML Job Submitted"
            echo "- **Workspace**: ${AZURE_ML_WORKSPACE}"
            echo "- **Resource Group**: ${AZURE_RESOURCE_GROUP}"
            echo "- **Region**: ${AZURE_REGION}"
            echo "- **Job Name**: ${{ steps.submit.outputs.job_name }}"
            echo "- **Studio link**: ${URL}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload job.json
        uses: actions/upload-artifact@v4
        with:
          name: aml-job-json
          path: job.json

      # ---------- SAFE LOGOUT ----------
      - name: Logout Azure
        if: always()
        continue-on-error: true
        run: |
          az account show >/dev/null 2>&1 && az logout || echo "No active Azure login; skipping logout."
