name: aml-mlops-cicd

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-train-register:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # NOTE: We do NOT use azure/cli here. It requires an inlineScript.
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # pin marshmallow to v3 to satisfy azure-ai-ml
          pip install "marshmallow<4,>=3.18"
          pip install azure-ai-ml==1.20.0 mlflow==2.16.0 scikit-learn==1.5.2 pandas==2.2.2 numpy==1.26.4 joblib==1.4.2 matplotlib==3.9.0


      - name: Submit Azure ML pipeline
        env:
          AML_SUBSCRIPTION_ID: f7583458-6f5b-4491-add9-f827568d2957
          AML_RESOURCE_GROUP: MSFT-AI-Class
          AML_WORKSPACE_NAME: MyFirstWorkSpace
          AML_COMPUTE_NAME: Keith-Compute
          AML_LOCATION: eastus
        run: |
          python aml/pipeline.py
