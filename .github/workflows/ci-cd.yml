# .github/workflows/ci-cd.yml
# Train → Register → Deploy (online) on Azure ML

name: aml-mlops-cicd

on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  # ===== Azure resources =====
  AZURE_RESOURCE_GROUP: MSFT-AI-Class
  AZURE_ML_WORKSPACE: MyFirstWorkSpace
  AZURE_REGION: eastus
  AML_COMPUTE: Keith-Compute

  # ===== Pipeline =====
  AML_PIPELINE_FILE: aml/pipeline.yml
  AML_JOB_NAME: auto-pricing-e2e
  AML_INPUT_DATA: azureml:UsedCars:1   # uri_file data asset

jobs:
  build-train-register:
    runs-on: ubuntu-latest
    outputs:
      job_name: ${{ steps.submit.outputs.job_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Auth mode
        id: auth
        shell: bash
        run: |
          if [ -n "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "mode=sp" >> "$GITHUB_OUTPUT"
          else
            echo "mode=oidc" >> "$GITHUB_OUTPUT"
          fi

      - name: Azure login (Service Principal)
        if: steps.auth.outputs.mode == 'sp'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure login (OIDC)
        if: steps.auth.outputs.mode == 'oidc'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify login
        shell: bash
        run: az account show >/dev/null

      - name: Install Azure ML CLI v2
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az extension remove -n azure-cli-ml || true
          az extension add -n ml --upgrade -y
          python -m pip install --upgrade pip
          pip install "azure-ai-ml>=1.16.0" "azure-identity>=1.16.0"

      - name: Submit Azure ML pipeline job
        id: submit
        shell: bash
        env:
          SUB_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail
          [ -n "${SUB_ID:-}" ] && az account set --subscription "$SUB_ID" || true
          BASE="${AML_JOB_NAME:-auto-pricing-e2e}"
          SUFFIX="$(date -u +%y%m%d-%H%M%S)-${GITHUB_RUN_NUMBER:-0}"
          NAME="$(echo "${BASE}-${SUFFIX}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')"

          JOB_JSON="$(az ml job create \
            --file "${AML_PIPELINE_FILE}" \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --workspace-name "${AZURE_ML_WORKSPACE}" \
            --name "${NAME}" \
            --set inputs.data="${AML_INPUT_DATA}" \
                  settings.default_compute="azureml:${AML_COMPUTE}" \
            -o json --only-show-errors)"

          echo "${JOB_JSON}" > job.json
          JOB_NAME=$(python -c "import json; print(json.load(open('job.json'))['name'])")
          echo "job_name=${JOB_NAME}" >> "$GITHUB_OUTPUT"

      - name: Post Azure ML Studio link
        shell: bash
        run: |
          set -euo pipefail
          JOB="${{ steps.submit.outputs.job_name }}"
          URL="$(az ml job show --name "$JOB" \
                 --resource-group "${AZURE_RESOURCE_GROUP}" \
                 --workspace-name "${AZURE_ML_WORKSPACE}" \
                 --query "coalesce(studio_url, studioUrl)" -o tsv 2>/dev/null || true)"
          echo "## ✅ Azure ML Job Submitted" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Job**: ${JOB}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Link**: ${URL:-(pending)}" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload job.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: aml-job-json
          path: job.json

      - name: Logout Azure
        if: always()
        continue-on-error: true
        shell: bash
        run: |
          az account show >/dev/null 2>&1 && az logout || true
          az account clear || true

  deploy-online:
    needs: build-train-register
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Azure ML CLI v2
        shell: bash
        run: |
          sudo apt-get update
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az extension add -n ml --upgrade -y

      - name: Create endpoint (idempotent)
        shell: bash
        run: |
          az ml online-endpoint create -f infra/endpoint.yaml \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --workspace-name "${{ env.AZURE_ML_WORKSPACE }}" || true

      - name: Pin latest registered model into deployment spec
        shell: bash
        run: |
          VER=$(az ml model list \
            --name auto-pricing-model \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --workspace-name "${{ env.AZURE_ML_WORKSPACE }}" \
            --query "[0].version" -o tsv)
          echo "MODEL_VER=$VER" >> $GITHUB_ENV
          sed "s|azureml:auto-pricing-model:@latest|azureml:auto-pricing-model:${VER}|" \
            infra/deployment-blue.yaml > /tmp/deployment-blue.yaml

      - name: Deploy model (blue) & route all traffic
        shell: bash
        run: |
          az ml online-deployment create \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --workspace-name "${{ env.AZURE_ML_WORKSPACE }}" \
            -f /tmp/deployment-blue.yaml --all-traffic

      - name: Smoke test
        shell: bash
        run: |
          ENDPOINT=$(az ml online-endpoint show -n auto-pricing-ep \
                   --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
                   --workspace-name "${{ env.AZURE_ML_WORKSPACE }}" \
                   --query scoring_uri -o tsv)
          KEY=$(az ml online-endpoint get-keys -n auto-pricing-ep \
              --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
              --workspace-name "${{ env.AZURE_ML_WORKSPACE }}" \
              --query primaryKey -o tsv)
          curl -s -H "Authorization: Bearer $KEY" -H "Content-Type: application/json" \
            -d '{"inputs":[{"features":[120000, 2017, 2.4]}]}' "$ENDPOINT" | tee /tmp/resp.json
