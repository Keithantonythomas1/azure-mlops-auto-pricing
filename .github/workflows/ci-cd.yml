name: aml-mlops-cicd

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP:  MSFT-AI-Class
  AZURE_ML_WORKSPACE:    MyFirstWorkSpace
  AZURE_LOCATION:        eastus
  COMPONENT_NAME:        train_random_forest
  COMPONENT_FILE:        components/train.yml   # auto-resolve if not found
  PIPELINE_FILE:         aml/pipeline.yml

jobs:
  build-train-register:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Azure login via OpenID Connect
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Install / Update Azure ML CLI v2
        run: |
          set -euo pipefail
          az extension add -n ml --upgrade -y
          az ml -h 1>/dev/null

      - name: Configure defaults
        run: |
          set -euo pipefail
          az account set --subscription "${{ vars.AZURE_SUBSCRIPTION_ID }}"
          az configure --defaults group="${AZURE_RESOURCE_GROUP}" workspace="${AZURE_ML_WORKSPACE}" location="${AZURE_LOCATION}"

      # --- Resolve component path if the default isn't present ---
      - name: Resolve component path
        id: resolve_component
        run: |
          set -euo pipefail
          if [ -f "${COMPONENT_FILE}" ]; then
            echo "path=${COMPONENT_FILE}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Provided COMPONENT_FILE not found: ${COMPONENT_FILE}"
          echo "Searching for a component YAML under components/ …"

          FOUND=""
          while IFS= read -r -d '' f; do
            if grep -qE '^[[:space:]]*name:[[:space:]]*train_random_forest' "$f"; then
              FOUND="$f"; break
            fi
          done < <(find . -type f \( -path '*/components/*.yml' -o -path '*/components/*.yaml' \) -print0 2>/dev/null)

          if [ -z "$FOUND" ]; then
            echo "❌ No component YAML found under components/. Repository tree:"
            git ls-files | sed 's/^/ - /'
            exit 1
          fi

          echo "✅ Using component: $FOUND"
          echo "path=$FOUND" >> "$GITHUB_OUTPUT"

      - name: Check current component versions
        id: list_versions
        run: |
          set -euo pipefail
          az ml component list --name "${COMPONENT_N_
