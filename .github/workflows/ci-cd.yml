name: aml-mlops-cicd

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  # Use repo VARIABLES (Settings ➜ Variables). Switch to secrets.* if you stored them as secrets.
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP:  MSFT-AI-Class
  AZURE_ML_WORKSPACE:    MyFirstWorkSpace
  AZURE_LOCATION:        eastus

  COMPONENT_NAME:        train_random_forest
  # If this exact file exists it will be used. Otherwise we’ll auto-discover a component YAML.
  COMPONENT_FILE:        components/train.yml
  PIPELINE_FILE:         aml/pipeline.yml

jobs:
  build-train-register:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Azure login via OpenID Connect
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure identity
        run: az account show

      - name: Install / Update Azure ML CLI v2
        run: |
          az extension add -n ml -y || az extension update -n ml
          az ml -h 1>/dev/null

      - name: Configure defaults
        run: |
          az account set --subscription "${AZURE_SUBSCRIPTION_ID}"
          az configure --defaults group="${AZURE_RESOURCE_GROUP}" workspace="${AZURE_ML_WORKSPACE}" location="${AZURE_LOCATION}"

      # ---------- FIX: Resolve the component YAML safely ----------
      - name: Resolve component file
        id: resolve_component
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATE="${COMPONENT_FILE}"

          if [[ -f "$CANDIDATE" ]]; then
            echo "Found component file: $CANDIDATE"
            echo "path=$CANDIDATE" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Provided COMPONENT_FILE not found: $CANDIDATE"
          echo "Searching for a component YAML under components/ …"
          FOUND="$(git ls-files | grep -Ei '^components/.*\.(yml|yaml)$' | head -n1 || true)"

          if [[ -z "${FOUND}" ]]; then
            echo "❌ No component YAML found under components/. Repository tree:"
            git ls-files | sed 's/^/ - /'
            exit 1
          fi

          echo "Auto-discovered component file: ${FOUND}"
          echo "path=${FOUND}" >> "$GITHUB_OUTPUT"

      - name: Check current component versions
        id: list_versions
        run: |
          az ml component list --name "${COMPONENT_NAME}" -o table || echo "No previous versions found"
          VER=$(az ml component list --name "${COMPONENT_NAME}" --query "[].version" -o tsv | sort -V | tail -n1)
          echo "highest_version=${VER:-0}" >> $GITHUB_OUTPUT

      - name: Compute next version and register
        id: register
        shell: bash
        run: |
          set -euo pipefail
          SRC="${{ steps.resolve_component.outputs.path }}"
          CUR="${{ steps.list_versions.outputs.highest_version }}"
          NEXT=$(( ${CUR:-0} + 1 ))

          echo "Next version will be ${NEXT}"
          # Create a temp with version injected or replaced
          if grep -Eq '^[[:space:]]*version:' "$SRC"; then
            # replace existing version line (yaml kept simple)
            awk -v v="${NEXT}" '
              BEGIN{done=0}
              /^[[:space:]]*version:[[:space:]]*/ { print "version: " v; done=1; next }
              { print }
              END{ if(done==0) print "version: " v }
            ' "$SRC" > component_temp.yml
          else
            # insert version right after the name: line if present, otherwise append at end
            awk -v v="${NEXT}" '
              BEGIN{added=0}
              /^[[:space:]]*name:[[:space:]]*/ { print; print "version: " v; added=1; next }
              { print }
              END{ if(added==0) print "version: " v }
            ' "$SRC" > component_temp.yml
          fi

          echo "----- component_temp.yml -----"
          sed -n '1,80p' component_temp.yml

          az ml component create --file component_temp.yml
          echo "registered_version=${NEXT}" >> $GITHUB_OUTPUT

      - name: Verify registration
        run: |
          az ml component show --name "${COMPONENT_NAME}" --version "${{ steps.register.outputs.registered_version }}" -o table

      - name: Update pipeline to reference new version
        id: patch_pipeline
        shell: bash
        run: |
          set -euo pipefail
          NEXT="${{ steps.register.outputs.registered_version }}"
          cp "${PIPELINE_FILE}" pipeline_temp.yml

          # Update any reference like: component: azureml:train_random_forest:1
          sed -E "s|(component:[[:space:]]*azureml:${COMPONENT_NAME}:)[^[:space:]]+|\\1${NEXT}|g" -i pipeline_temp.yml || true

          echo "tmp_pipeline=pipeline_temp.yml" >> $GITHUB_OUTPUT

      - name: Submit pipeline
        id: run_pipeline
        run: |
          JOB=$(az ml job create --file ${{ steps.patch_pipeline.outputs.tmp_pipeline }} --query name -o tsv)
          echo "job_name=${JOB}" >> $GITHUB_OUTPUT
          echo "✅ Submitted pipeline job: ${JOB}"

      - name: Save job metadata
        if: always()
        run: |
          JOB=${{ steps.run_pipeline.outputs.job_name }}
          if [ -n "$JOB" ]; then
            az ml job show --name "$JOB" -o json > aml-job.json
            echo "https://ml.azure.com/experiments/${{ github.event.repository.name }}/runs/${JOB}" > aml-studio-link.txt
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aml-job-info
          path: |
            aml-job.json
            aml-studio-link.txt
