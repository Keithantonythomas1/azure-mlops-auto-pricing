name: aml-mlops-cicd

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP:  MSFT-AI-Class
  AZURE_ML_WORKSPACE:    MyFirstWorkSpace
  AZURE_LOCATION:        eastus
  COMPONENT_NAME:        train_random_forest
  COMPONENT_FILE:        components/train.yml          # will auto-resolve if missing
  PIPELINE_FILE:         aml/pipeline.yml

jobs:
  build-train-register:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      # Fix: explicitly select SERVICE_PRINCIPAL to avoid "OIDC" auth-type crash
      - name: Azure login via OpenID Connect
        uses: azure/login@v2
        with:
          auth-type: SERVICE_PRINCIPAL
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Install / Update Azure ML CLI v2
        run: |
          set -euo pipefail
          az extension add -n ml --upgrade -y
          az ml -h 1>/dev/null

      - name: Configure defaults
        run: |
          set -euo pipefail
          az account set --subscription "${{ vars.AZURE_SUBSCRIPTION_ID }}"
          az configure --defaults group="${AZURE_RESOURCE_GROUP}" workspace="${AZURE_ML_WORKSPACE}" location="${AZURE_LOCATION}"

      # --- Resolve component path if the default isn't present ---
      - name: Resolve component path
        id: resolve_component
        run: |
          set -euo pipefail
          if [ -f "${COMPONENT_FILE}" ]; then
            echo "path=${COMPONENT_FILE}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Provided COMPONENT_FILE not found: ${COMPONENT_FILE}"
          echo "Searching under */components/*.y*ml …"
          FOUND=""
          while IFS= read -r -d '' f; do
            if grep -qE '^[[:space:]]*name:[[:space:]]*'${COMPONENT_NAME} "$f"; then
              FOUND="$f"; break
            fi
          done < <(find . -type f \( -path '*/components/*.yml' -o -path '*/components/*.yaml' \) -print0 2>/dev/null)
          if [ -z "$FOUND" ]; then
            echo "❌ No component YAML found under components/. Repo tree:"; git ls-files | sed 's/^/ - /'
            exit 1
          fi
          echo "✅ Using component: $FOUND"
          echo "path=$FOUND" >> "$GITHUB_OUTPUT"

      - name: Check current component versions
        id: list_versions
        run: |
          set -euo pipefail
          az ml component list --name "${COMPONENT_NAME}" -o table || echo "No previous versions found"
          VER=$(az ml component list --name "${COMPONENT_NAME}" --query "[].version" -o tsv | sort -V | tail -n1)
          echo "highest_version=${VER:-0}" >> "$GITHUB_OUTPUT"

      # --- Resolve curated sklearn CPU environment from the public 'azureml' registry ---
      - name: Resolve curated sklearn CPU environment (from registry)
        id: resolve_env
        run: |
          set -euo pipefail

          list_envs () {
            local jmes="$1"
            az ml environment list \
              --registry-name azureml \
              --query "$jmes" \
              -o tsv
          }

          # Prefer ubuntu20.04 + py39/py310 + cpu + AzureML-sklearn
          CANDIDATES="$(list_envs "[?contains(name, 'AzureML-sklearn') && contains(name,'cpu') && contains(name,'ubuntu20.04') && (contains(name,'py39') || contains(name,'py310'))].[name,version]")"
          # Fallback: any AzureML-sklearn cpu
          if [ -z "$CANDIDATES" ]; then
            CANDIDATES="$(list_envs "[?contains(name, 'AzureML-sklearn') && contains(name,'cpu')].[name,version]")"
          fi
          if [ -z "$CANDIDATES" ]; then
            echo "❌ No curated AzureML-sklearn CPU environments found in registry 'azureml'."
            exit 1
          fi

          SEL="$(echo "$CANDIDATES" | sort -k1,1 -k2,2V | tail -n1)"
          NAME="$(echo "$SEL" | awk '{print $1}')"
          VERSION="$(echo "$SEL" | awk '{print $2}')"

          if [ -z "$NAME" ] || [ -z "$VERSION" ] || [ "$VERSION" = "None" ]; then
            echo "❌ Invalid selection (name='$NAME', version='$VERSION')."; exit 1
          fi

          # Validate selection exists (prevents @latest and None bugs)
          az ml environment show --registry-name azureml --name "$NAME" --version "$VERSION" 1>/dev/null

          ENV_URI="azureml://registries/azureml/environments/${NAME}/versions/${VERSION}"
          echo "env_uri=${ENV_URI}" >> "$GITHUB_OUTPUT"
          echo "Resolved curated environment: ${ENV_URI}"

      # --- Build component_temp.yml, bump version, and PATCH environment to exact registry URI ---
      - name: Compute next version and register (with curated env patch)
        id: register
        run: |
          set -euo pipefail
          SRC="${{ steps.resolve_component.outputs.path }}"
          CUR="${{ steps.list_versions.outputs.highest_version }}"

          if [[ -z "$CUR" || "$CUR" == "0" ]]; then
            NEXT="$(date +%Y%m%d%H%M%S)"
          elif [[ "$CUR" =~ ^[0-9]+$ ]]; then
            NEXT=$(( CUR + 1 ))
          else
            NEXT="$(date +%Y%m%d%H%M%S)"
          fi
          echo "Next version will be ${NEXT}"

          # Create component_temp.yml with bumped version (insert if missing)
          if grep -Eq '^[[:space:]]*version:' "$SRC"; then
            awk -v v="${NEXT}" '
              BEGIN{done=0}
              /^[[:space:]]*version:[[:space:]]*/ { print "version: " v; done=1; next }
              { print }
              END{ if(done==0) print "version: " v }
            ' "$SRC" > component_temp.yml
          else
            awk -v v="${NEXT}" '
              BEGIN{added=0}
              /^[[:space:]]*name:[[:space:]]*/ { print; print "version: " v; added=1; next }
              { print }
              END{ if(added==0) print "version: " v }
            ' "$SRC" > component_temp.yml
          fi

          # Force the resolved curated environment from registry (exact name+version)
          ENV_URI="${{ steps.resolve_env.outputs.env_uri }}"
          if grep -Eq '^[[:space:]]*environment:' component_temp.yml; then
            sed -E "s|^[[:space:]]*environment:.*$|environment: ${ENV_URI}|" -i component_temp.yml
          else
            printf "\nenvironment: %s\n" "${ENV_URI}" >> component_temp.yml
          fi

          echo "----- component_temp.yml (first 80 lines) -----"
          sed -n '1,80p' component_temp.yml

          az ml component create --file component_temp.yml
          echo "registered_version=${NEXT}" >> "$GITHUB_OUTPUT"

      - name: Verify registration
        run: |
          set -euo pipefail
          az ml component show --name "${COMPONENT_NAME}" --version "${{ steps.register.outputs.registered_version }}" -o table

      - name: Update pipeline to reference new version
        id: patch_pipeline
        run: |
          set -euo pipefail
          NEXT="${{ steps.register.outputs.registered_version }}"
          if [ ! -f "${PIPELINE_FILE}" ]; then
            echo "Pipeline file not found: ${PIPELINE_FILE}"
            exit 1
          fi
          sed -E "s|(component:[[:space:]]*azureml:${COMPONENT_NAME}:)[^[:space:]]+|\\1${NEXT}|g" "${PIPELINE_FILE}" > pipeline_temp.yml
          echo "tmp_pipeline=pipeline_temp.yml" >> "$GITHUB_OUTPUT"
          echo "----- pipeline_temp.yml (first 60 lines) -----"
          sed -n '1,60p' pipeline_temp.yml

      - name: Submit pipeline
        id: run_pipeline
        run: |
          set -euo pipefail
          JOB=$(az ml job create --file "${{ steps.patch_pipeline.outputs.tmp_pipeline }}" --query name -o tsv)
          echo "job_name=${JOB}" >> "$GITHUB_OUTPUT"
          echo "✅ Submitted pipeline job: ${JOB}"

      - name: Save job metadata
        if: always()
        run: |
          set -euo pipefail
          JOB=${{ steps.run_pipeline.outputs.job_name }}
          if [ -n "${JOB:-}" ]; then
            az ml job show --name "$JOB" -o json > aml-job.json
            echo "https://ml.azure.com/experiments/${{ github.event.repository.name }}/runs/${JOB}" > aml-studio-link.txt
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aml-job-info
          path: |
            aml-job.json
            aml-studio-link.txt
