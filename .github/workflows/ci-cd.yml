name: aml-mlops-cicd

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-train-register:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # NOTE: We do NOT use azure/cli here. It requires an inlineScript.
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Install dependencies (pin compatible versions)
        run: |
          python -m pip install --upgrade pip
          # start clean to avoid a cached incompatible marshmallow
          pip uninstall -y marshmallow || true
          # this pair is known to work together
          pip install "marshmallow==3.21.1" "azure-ai-ml==1.14.0"
          # rest of your deps
          pip install mlflow==2.16.0 scikit-learn==1.5.2 pandas==2.2.2 numpy==1.26.4 joblib==1.4.2 matplotlib==3.9.0
          # show what actually got installed (for quick debugging if needed)
          python -c "import marshmallow, azure.ai.ml as aml; print('marshmallow', marshmallow.__version__); print('azure-ai-ml', aml.__version__)"

      - name: Submit Azure ML pipeline
        env:
          AML_SUBSCRIPTION_ID: f7583458-6f5b-4491-add9-f827568d2957
          AML_RESOURCE_GROUP: MSFT-AI-Class
          AML_WORKSPACE_NAME: MyFirstWorkSpace
          AML_COMPUTE_NAME: Keith-Compute
          AML_LOCATION: eastus
        run: |
          python aml/pipeline.py
