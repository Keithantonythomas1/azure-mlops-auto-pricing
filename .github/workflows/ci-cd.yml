name: build-train-register

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: MSFT-AI-Class
  AZURE_ML_WORKSPACE: MyFirstWorkSpace
  AZURE_REGION: eastus
  AML_COMPUTE: Keith-Compute
  AML_PIPELINE_FILE: aml/pipeline.yml
  AML_JOB_NAME: auto-pricing-e2e
  AML_INPUT_DATA: azureml:UsedCars:1

jobs:
  build-train-register:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Login to Azure using OIDC federated credentials
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          auth-type: IDENTITY
          enable-AzPSSession: false
          allow-no-subscriptions: true

      # 3Ô∏è‚É£ Set correct subscription + workspace context
      - name: Set Azure context
        run: |
          az account show || az account list -o table
          echo "‚úÖ Azure login successful"
          az configure --defaults group=${{ env.AZURE_RESOURCE_GROUP }} workspace=${{ env.AZURE_ML_WORKSPACE }} location=${{ env.AZURE_REGION }}

      # 4Ô∏è‚É£ Ensure latest Azure ML CLI extension
      - name: Install or update Azure ML CLI v2
        run: |
          az extension add -n ml -y || az extension update -n ml

      # 5Ô∏è‚É£ Submit the AML pipeline job with compute + dataset overrides
      - name: Submit pipeline to Azure ML
        run: |
          set -euo pipefail
          JOB_NAME="${{ env.AML_JOB_NAME }}-$(date +'%y%m%d-%H%M%S')"

          echo "üîß Submitting AML pipeline job: $JOB_NAME"
          az ml job create \
            --file ${{ env.AML_PIPELINE_FILE }} \
            --set settings.default_compute=azureml:${{ env.AML_COMPUTE }} \
            --set inputs.training_data=${{ env.AML_INPUT_DATA }} \
            --set inputs.target_column=price \
            --name "$JOB_NAME" \
            --query name -o tsv > jobname.txt

          JOB=$(cat jobname.txt)
          echo "{\"job\":\"$JOB\"}" > aml-job.json

          echo "‚úÖ Job submitted: $JOB"
          echo "üîó Studio link:"
          echo "https://ml.azure.com/experiments/${{ env.AML_JOB_NAME }}/jobs/$JOB/overview?wsid=/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.MachineLearningServices/workspaces/${{ env.AZURE_ML_WORKSPACE }}"

      # 6Ô∏è‚É£ (Optional) Upload AML job metadata for reference
      - name: Upload AML job info
        uses: actions/upload-artifact@v4
        with:
          name: aml-job-metadata
          path: aml-job.json

      # 7Ô∏è‚É£ Logout from Azure cleanly
      - name: Cleanup Azure session
        run: |
          az account clear || true
