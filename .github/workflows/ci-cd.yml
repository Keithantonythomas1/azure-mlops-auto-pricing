name: build-train-register

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write        # Required for OIDC federation
  contents: read

env:
  AZURE_RESOURCE_GROUP: MSFT-AI-Class
  AZURE_ML_WORKSPACE: MyFirstWorkSpace
  AZURE_REGION: eastus
  AML_COMPUTE: Keith-Compute                 # Your Azure ML compute cluster
  AML_PIPELINE_FILE: aml/pipeline.yml
  AML_JOB_NAME: auto-pricing-e2e
  AML_INPUT_DATA: azureml:UsedCars:1         # Adjust dataset name/version as needed

jobs:
  build-train-register:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Azure Login using OIDC (Entra App with federated credential)
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID || secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID || secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID || secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: false

      # 3Ô∏è‚É£ Validate and set Azure context defaults
      - name: Set Azure context
        run: |
          set -euo pipefail
          echo "üîπ Confirming Azure login..."
          az account show -o table
          az configure --defaults group=${{ env.AZURE_RESOURCE_GROUP }} \
                        workspace=${{ env.AZURE_ML_WORKSPACE }} \
                        location=${{ env.AZURE_REGION }}
          echo "‚úÖ Context set for workspace: ${{ env.AZURE_ML_WORKSPACE }}"

      # 4Ô∏è‚É£ Ensure Azure ML CLI v2 is installed or updated
      - name: Install or update Azure ML CLI v2
        run: |
          az extension add -n ml -y || az extension update -n ml

      # 5Ô∏è‚É£ Submit the AML pipeline
      - name: Submit pipeline to Azure ML
        run: |
          set -euo pipefail
          JOB_NAME="${{ env.AML_JOB_NAME }}-$(date +'%y%m%d-%H%M%S')"

          echo "üöÄ Submitting AML pipeline job: $JOB_NAME"
          az ml job create \
            --file ${{ env.AML_PIPELINE_FILE }} \
            --set settings.default_compute=azureml:${{ env.AML_COMPUTE }} \
            --set inputs.training_data=${{ env.AML_INPUT_DATA }} \
            --set inputs.target_column=price \
            --name "$JOB_NAME" \
            --query name -o tsv > jobname.txt

          JOB=$(cat jobname.txt)
          echo "{\"job\":\"$JOB\"}" > aml-job.json

          echo "‚úÖ Job submitted: $JOB"
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          echo "üîó Azure ML Studio job link:"
          echo "https://ml.azure.com/experiments/${{ env.AML_JOB_NAME }}/jobs/$JOB/overview?wsid=/subscriptions/$SUBSCRIPTION_ID/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.MachineLearningServices/workspaces/${{ env.AZURE_ML_WORKSPACE }}"

      # 6Ô∏è‚É£ Upload job metadata
      - name: Upload AML job metadata
        uses: actions/upload-artifact@v4
        with:
          name: aml-job-metadata
          path: aml-job.json

      # 7Ô∏è‚É£ Logout & cleanup
      - name: Cleanup Azure session
        run: |
          az account clear || true
          echo "üßπ Azure CLI session cleared."
