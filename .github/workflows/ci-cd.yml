# .github/workflows/ci-cd.yml
# End-to-end Azure ML CI/CD (v2)
# âœ… OIDC-first auth, ML v2 extension, safe step scripts, compute patched via --set

name: aml-mlops-cicd
on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  # ===== Azure resources =====
  AZURE_RESOURCE_GROUP: MSFT-AI-Class
  AZURE_ML_WORKSPACE:  MyFirstWorkSpace
  AZURE_REGION:        eastus

  # ===== Pipeline configuration =====
  AML_PIPELINE_FILE:   aml/pipeline.yml
  AML_JOB_NAME:        auto-pricing-e2e
  AML_INPUT_DATA:      azureml:UsedCars:1        # dataset in your workspace
  AML_COMPUTE:         Keith-Compute             # compute cluster name

jobs:
  build-train-register:
    runs-on: ubuntu-latest

    steps:
      # ================= CHECKOUT & PYTHON =================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ================= AUTHENTICATION =================
      - name: Select auth mode
        id: auth
        shell: bash
        run: |
          if [ -n "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "mode=sp" >> "$GITHUB_OUTPUT"
            echo "Using Service Principal (AZURE_CREDENTIALS present)."
          else
            echo "mode=oidc" >> "$GITHUB_OUTPUT"
            echo "Using OIDC (recommended)."
          fi

      - name: Azure login (Service Principal)
        if: steps.auth.outputs.mode == 'sp'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure login (OIDC)
        if: steps.auth.outputs.mode == 'oidc'
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Azure login is active
        shell: bash
        run: |
          if ! az account show >/dev/null 2>&1; then
            echo "::error::No active Azure login. Check OIDC/SP secrets."
            exit 1
          fi
          echo "âœ… Azure login verified."

      # ================= INSTALL AZURE CLI + ML V2 EXT =================
      - name: Install or upgrade Azure CLI + ML v2 extension
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ”¹ Installing/Updating Azure CLI..."
          sudo apt-get update
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

          echo "ðŸ”¹ Remove legacy ML extension (if any)..."
          az extension remove -n azure-cli-ml || true

          echo "ðŸ”¹ Install ML v2 extension..."
          az extension add -n ml --upgrade -y

          echo "ðŸ”¹ Verify install..."
          az version
          az extension show -n ml

          echo "ðŸ”¹ Python deps (SDKs)..."
          python -m pip install --upgrade pip
          pip install "azure-ai-ml>=1.16.0" "azure-identity>=1.16.0"
          echo "âœ… Azure CLI + ML v2 ready."

      # ================= SUBMIT AML PIPELINE =================
      - name: Submit Azure ML pipeline job
        id: submit
        shell: bash
        env:
          SUB_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail

          if [ -n "${SUB_ID:-}" ]; then
            az account set --subscription "$SUB_ID"
          fi

          echo "ðŸŒ Active context:"
          az account show --query "{Name:name, TenantId:tenantId, SubscriptionId:id}" -o table

          echo "ðŸ”¹ Unique job name..."
          BASE="${AML_JOB_NAME:-auto-pricing-e2e}"
          SUFFIX="$(date -u +%y%m%d-%H%M%S)-${GITHUB_RUN_NUMBER:-0}"
          UNIQUE_NAME="$(echo "${BASE}-${SUFFIX}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')"
          echo "ðŸ“› ${UNIQUE_NAME}"

          echo "ðŸ“¤ Submitting pipeline..."
          JOB_JSON="$(az ml job create \
            --file "${AML_PIPELINE_FILE}" \
            --resource-group "${AZURE_RESOURCE_GROUP}" \
            --workspace-name "${AZURE_ML_WORKSPACE}" \
            --name "${UNIQUE_NAME}" \
            --set inputs.data="${AML_INPUT_DATA}" \
                  settings.default_compute="azureml:${AML_COMPUTE}" \
            --only-show-errors -o json)"

          echo "${JOB_JSON}" > job.json

          if command -v jq >/dev/null 2>&1; then
            JOB_NAME=$(jq -r '.name' job.json)
          else
            JOB_NAME=$(python -c "import json;print(json.load(open('job.json'))['name'])")
          fi
          echo "job_name=${JOB_NAME}" >> "$GITHUB_OUTPUT"
          echo "âœ… Job submitted: ${JOB_NAME}"

      # ================= POST-STUDIO SUMMARY (fixed) =================
      - name: Post Azure ML Studio link
        shell: bash
        run: |
          set -euo pipefail
          JOB="${{ steps.submit.outputs.job_name }}"
          # capture URL, suppress SDK experimental warnings
          URL="$(az ml job show \
                  --name "$JOB" \
                  --resource-group "${AZURE_RESOURCE_GROUP}" \
                  --workspace-name "${AZURE_ML_WORKSPACE}" \
                  --query "coalesce(studio_url, studioUrl)" -o tsv 2>/dev/null || true)"
          echo "## âœ… Azure ML Job Submitted" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Workspace**: ${AZURE_ML_WORKSPACE}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Resource Group**: ${AZURE_RESOURCE_GROUP}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Region**: ${AZURE_REGION}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Job Name**: ${JOB}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Studio Link**: ${URL:-(not available yet)}" >> "$GITHUB_STEP_SUMMARY"

      # ================= ARTIFACT & LOGOUT =================
      - name: Upload job.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: aml-job-json
          path: job.json

      - name: Logout Azure
        if: always()
        continue-on-error: true
        shell: bash
        run: |
          az account show >/dev/null 2>&1 && az logout || echo "No active Azure login; skipping logout."
          az account clear || true
          echo "ðŸ§¹ Azure session cleared."
