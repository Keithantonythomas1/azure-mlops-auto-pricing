name: aml-mlops-cicd

on:
  workflow_dispatch:

env:
  AZURE_REGION: eastus
  AZURE_RESOURCE_GROUP: MSFT-AI-Class
  AZURE_ML_WORKSPACE: MyFirstWorkSpace
  AML_COMPUTE: Keith-Compute
  AML_PIPELINE_FILE: aml/pipeline.yml

  # Dataset asset to use as the pipeline "data" input (edit if your asset name/version differs)
  AML_INPUT_DATA: azureml:UsedCars:1

  # Job base name (a timestamp is appended)
  AML_JOB_NAME: auto-pricing-e2e

jobs:
  build-train-register:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Azure CLI login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Azure ML CLI
        shell: bash
        run: |
          az extension add -n ml -y || az extension update -n ml
          az configure --defaults group=$AZURE_RESOURCE_GROUP workspace=$AZURE_ML_WORKSPACE location=$AZURE_REGION

      - name: Submit Azure ML pipeline job
        id: submit
        shell: bash
        run: |
          TS=$(date +%y%m%d-%H%M%S)
          NAME="${AML_JOB_NAME}-${TS}"

          # Submit with input binding
          az ml job create \
            --file "$AML_PIPELINE_FILE" \
            --name "$NAME" \
            --set inputs.data="${AML_INPUT_DATA}"

          echo "job_name=$NAME" >> $GITHUB_OUTPUT

      - name: Retrieve Azure ML Studio link
        shell: bash
        run: |
          JOB="${{ steps.submit.outputs.job_name }}"
          # Build Studio URL (robust across CLI versions)
          JOBJSON=$(az ml job show -n "$JOB" -o json)
          echo "$JOBJSON" | tee aml-job.json >/dev/null

          # Try to form a Studio link
          WSID=$(echo "$JOBJSON" | jq -r ".properties.workspaceArmId")
          SUB=$(echo "$WSID" | awk -F'/' '{print $3}')
          RG=$(echo "$WSID" | awk -F'/' '{print $5}')
          WS=$(echo "$WSID" | awk -F'/' '{print $9}')
          EXP=$(echo "$JOBJSON" | jq -r ".properties.experimentName")
          echo "Job: $JOB"
          echo "Studio Link: https://ml.azure.com/experiments/${EXP}/jobs/${JOB}/overview?wsid=/subscriptions/${SUB}/resourceGroups/${RG}/providers/Microsoft.MachineLearningServices/workspaces/${WS}"

      - name: Upload job.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: aml-job-json
          path: aml-job.json

      - name: Logout Azure
        if: always()
        run: |
          az logout || true
          az account clear || true
